<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/polymer-fontawesome/polymer-fontawesome.html">

<!-- expects the answer in the form {html:'',prev:'',next:''} -->
<polymer-element name="mudasobwa-content-loader" attributes="article url title prefetch next prev">
  <template>
		<style>
			:host {
				display: none;
			}
		</style>

		<core-ajax id="current"
			url="{{ url }}"
			on-core-response="{{ contentLoaded }}"
			handleAs="json">
		</core-ajax>
		<template id="prevnext" if="{{ prefetch == 'true' }}">
			<mudasobwa-content-loader id="prev" prefetch="false" url="{{ prev }}"></mudasobwa-content-loader>
			<mudasobwa-content-loader id="next" prefetch="false" url="{{ next }}"></mudasobwa-content-loader>
		</template>
  </template>

	<script>
		Polymer('mudasobwa-content-loader', {
			created: function() {
				this.article = '';
				this.next = null;
				this.prev = null;
			},
			attached: function() {
				this.reload();
			},
			contentLoaded: function() {
				this.article = this.$.current.response.html;
				this.title = this.$.current.response.title;
				this.prev = this.$.current.response.prev;
				this.next = this.$.current.response.next;

				if(this.prefetch == 'true') {
					this.$.prev.reload();
					this.$.next.reload();
				}
			},
			reload: function() {
				this.$.current.go();
			},
			goto: function(url) {
				this.url = url;
				this.reload();
			},
			step: function(forward) {
				this.url = (true === forward) ? this.next: this.prev;
				this.reload();
			},
			dup: function(other) {
				if(typeof other !== 'undefined') {
					this.url = other.url;
					this.next = other.next;
					this.prev = other.prev;
					this.title = other.title;
					this.article = other.article;
				} else {
					this.next = this.prev = this.title = this.article = this.url = null;
				}
			},
			yo: function(previous) {
				if(this.prefetch !== 'true') {
					this.reload();
					return;
				}
				if(previous === true) {
					this.$.next.dup(this);
					if(this.$.prev) {
						this.dup(this.$.prev);
					} else {
						this.step(false);
					}
					this.$.prev.step(false);
				} else {
					this.$.prev.dup(this);
					if(this.$.next) {
						this.dup(this.$.next);
					} else {
						this.step(true);
					}
					this.$.next.step(true);
				}
			}
		});
	</script>
</polymer-element>

<polymer-element name="opaque-button" noscript>
	<template>
		<style>
			:host {
				width: 100%;
				height: 100%;
				opacity: 0.5;
				transition: opacity 400ms ease-in-out;
				cursor: pointer;
			}
			:host(:hover) { opacity: 1; }
		</style>
		<content></content>
		<script>
		  Polymer('opaque-button', {
		  });
		</script>
	</template>
</polymer-element>

<polymer-element name="html-echo" attributes="html">
	<script>
		Polymer('html-echo', {
			htmlChanged: function() {
				// WARNING: potential XSS vulnerability if `html` comes from an untrusted source
				this.innerHTML = this.html;
			}
		});
	</script>
</polymer-element>

<polymer-element name="mudasobwa-content-slider" attributes="url title prefetch buttons previcon nexticon">
	<template>
		<style>
			:host {
				display: block;
				position: relative;
				opacity: 0.8;
				transition: opacity .5s,transform 1s;
			}
			div.slider-content { margin: 0 4em; padding: 0; }
		</style>
		<div class="slider-container">
			<template if="{{ buttons == 'prev' || buttons == 'both' }}">
				<style>
					div.slider-nav-left { margin: 0; padding: 0; position: absolute; top: 0; left: 0.4em; }
				</style>
				<div class="slider-nav-left">
					<opaque-button id="prevbtn" on-mouseover="{{ buttonHover }}" on-click="{{ buttonClick }}"><font-awesome icon="{{ previcon }}"></font-awesome></opaque-button>
				</div>
			</template>
			<template if="{{ buttons == 'next' || buttons == 'both' }}"> <!-- FIXME ------- WHY /next/.test(buttons) sucks??? -->
				<style>
					div.slider-nav-right { margin: 0; padding: 0; position: absolute; top: 0; right: 0.4em; }
				</style>
				<div class="slider-nav-right">
					<opaque-button id="nextbtn" on-click="{{ buttonClick }}"><font-awesome icon="{{ nexticon }}"></font-awesome></opaque-button>
				</div>
			</template>

			<div class="slider-content">
				<mudasobwa-content-loader id="content" url="{{ url }}" article="{{ article }}" prefetch="{{ prefetch }}"></mudasobwa-content-loader>
				<html-echo id="placeholder" html="{{ article }}"></html-echo>
			</div>
		</div>
		<!--notification-elements
				id="growl"
				header="Meooow!"
				body="I'm the Octocat!"
				icon="http://forum.webflow.com/plugins/emoji/images/octocat.png">
		</notification-elements-->
	</template>
	<script>
		Polymer('mudasobwa-content-slider', {
			created: function() {
				this.previcon = "angle-double-left";
				this.nexticon = "angle-double-right";
			},
			articleChanged: function() {
				this.title = this.$.content.title;
				if(typeof this.$.prevbtn !== 'undefined')
					this.$.prevbtn.style.display = ('null' === String(this.$.content.prev)) ? 'none' : 'block';
				if(typeof this.$.nextbtn !== 'undefined')
					this.$.nextbtn.style.display = ('null' === String(this.$.content.next)) ? 'none' : 'block';
			},
			buttonClick: function(event, detail, sender) {
				this.$.content.yo(sender.id === "prevbtn");
			},
			buttonHover: function(event, detail, sender) {
				// this.$.growl.notify(); // = this.$.content.url;
			}
		});
	</script>
</polymer-element>